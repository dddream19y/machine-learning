{% extends "base.html" %}

{% block title %}é æ¸¬æ¸¬è©¦ - å¿ƒè‡Ÿç—…é æ¸¬ç³»çµ±{% endblock %}

{% block content %}
<!-- åŠ å…¥åˆ—å°å°ˆç”¨çš„ CSS æ¨£å¼ -->
<style>
    /* é è¨­éš±è—å ±å‘Šé ­éƒ¨ï¼Œåªæœ‰åˆ—å°æ™‚æ‰é¡¯ç¤º */
    #printHeader {
        display: none;
    }

    /* @media print ä»£è¡¨ã€Œåªæœ‰åˆ—å°æ™‚ã€æ‰æœƒç”Ÿæ•ˆçš„æ¨£å¼ */
    @media print {

        /* éš±è—ä¸éœ€è¦çš„å…ƒç´ ï¼šå°è¦½åˆ—ã€è¼¸å…¥è¡¨å–®ã€æŒ‰éˆ•ã€é å°¾ */
        .navbar,
        footer,
        .input-section,
        .btn,
        .card-header,
        .alert-info i {
            display: none !important;
        }

        /* è®“çµæœå€å¡Šä½”æ»¿æ•´å¼µç´™ */
        .container,
        .row,
        .col-lg-5 {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            flex: none !important;
        }

        /* é¡¯ç¤ºå ±å‘Šé ­éƒ¨ */
        #printHeader {
            display: block;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        /* èª¿æ•´çµæœå¡ç‰‡çš„æ¨£å¼ï¼Œè®“å®ƒé©åˆåˆ—å°ï¼ˆç™½åº•é»‘å­—æ¯”è¼ƒçœå¢¨æ°´ï¼‰ */
        .result-card {
            background: white !important;
            color: black !important;
            border: 1px solid #ddd;
            box-shadow: none !important;
        }

        /* ç¢ºä¿å­—é«”é¡è‰²åœ¨åˆ—å°æ™‚æ¸…æ™° */
        .display-4,
        h3,
        p {
            color: black !important;
        }

        body {
            background-color: white !important;
        }
    }
</style>

<div class="container py-5">
    <!-- é€™æ˜¯åªæœ‰åˆ—å°æ™‚æœƒå‡ºç¾çš„æ¨™é¡Œ -->
    <div id="printHeader">
        <h2>ğŸ¥ å¿ƒè‡Ÿç—…é¢¨éšªè©•ä¼°å ±å‘Š</h2>
        <p>æª¢æ¸¬æ—¥æœŸï¼š<span id="printDate"></span></p>
    </div>

    <h2 class="text-center mb-4 input-section">
        <i class="fas fa-stethoscope me-2"></i>å¿ƒè‡Ÿç—…é¢¨éšªé æ¸¬
    </h2>
    <p class="text-center text-muted mb-5 input-section">
        è«‹è¼¸å…¥æ‚¨çš„å¥åº·æŒ‡æ¨™ï¼Œç³»çµ±å°‡ä½¿ç”¨æ©Ÿå™¨å­¸ç¿’æ¨¡å‹é€²è¡Œé¢¨éšªè©•ä¼°
    </p>

    <div class="row">
        <!-- è¼¸å…¥è¡¨å–® (Input Form) - åŠ äº† input-section é¡åˆ¥ä»¥ä¾¿åˆ—å°æ™‚éš±è— -->
        <div class="col-lg-7 mb-4 input-section">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>è¼¸å…¥å¥åº·æŒ‡æ¨™</h5>
                </div>
                <div class="card-body">
                    <form id="predictForm">
                        <div class="row">
                            {% for name, info in features.items() %}
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ info.label }}</label>
                                {% if info.type == 'select' %}
                                <select class="form-select" name="{{ name }}" id="{{ name }}">
                                    {% for option in info.options %}
                                    <option value="{{ option.value }}" {% if option.value==info.default %}selected{%
                                        endif %}>
                                        {{ option.label }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% else %}
                                <input type="number" class="form-control" name="{{ name }}" id="{{ name }}"
                                    value="{{ info.default }}" {% if info.min is defined %}min="{{ info.min }}" {% endif
                                    %} {% if info.max is defined %}max="{{ info.max }}" {% endif %} {% if info.step is
                                    defined %}step="{{ info.step }}" {% endif %}>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <hr class="my-4">

                        <div class="mb-3">
                            <label class="form-label">é¸æ“‡é æ¸¬æ¨¡å‹</label>
                            <select class="form-select" name="model_type" id="model_type">
                                <optgroup label="Sklearn æ¨¡å‹">
                                    <option value="logistic_regression" selected>Logistic Regression</option>
                                    <option value="random_forest">Random Forest</option>
                                </optgroup>
                                <optgroup label="TensorFlow æ¨¡å‹">
                                    <option value="tf_model_sgd">TensorFlow - SGD Optimizer</option>
                                    <option value="tf_model_adam">TensorFlow - Adam Optimizer</option>
                                    <option value="tf_model_final">TensorFlow - Final Model</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-search me-2"></i>é€²è¡Œé æ¸¬
                                <span class="loading-spinner spinner-border spinner-border-sm ms-2"
                                    role="status"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- çµæœé¢æ¿ (Result Panel) -->
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-poll me-2"></i>é æ¸¬çµæœ</h5>
                </div>
                <div class="card-body" id="resultPanel">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-hand-point-left fa-3x mb-3"></i>
                        <p>è«‹å¡«å¯«å·¦å´è¡¨å–®ä¸¦é»æ“Šã€Œé€²è¡Œé æ¸¬ã€</p>
                    </div>
                </div>
            </div>

            <!-- å¿«é€Ÿæ¸¬è©¦æŒ‰éˆ• (åˆ—å°æ™‚æœƒéš±è—) -->
            <div class="card mt-4 input-section">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-flask me-2"></i>å¿«é€Ÿæ¸¬è©¦ç¯„ä¾‹</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¡«å…¥æ¸¬è©¦æ•¸æ“šï¼š</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-danger btn-sm" onclick="fillTestData('high_risk')">
                            <i class="fas fa-exclamation-triangle me-2"></i>é«˜é¢¨éšªæ¡ˆä¾‹
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="fillTestData('low_risk')">
                            <i class="fas fa-shield-alt me-2"></i>ä½é¢¨éšªæ¡ˆä¾‹
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="fillTestData('random')">
                            <i class="fas fa-random me-2"></i>éš¨æ©Ÿæ•¸æ“š
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // è¨­å®šåˆ—å°æ—¥æœŸ
    document.getElementById('printDate').innerText = new Date().toLocaleDateString();

    const testCases = {
        high_risk: {
            // å…¸å‹é«˜é¢¨éšªï¼š65æ­²ç”·æ€§ï¼Œç„¡ç—‡ç‹€ï¼Œé«˜è¡€å£“ï¼Œé«˜è†½å›ºé†‡ï¼Œé«˜è¡€ç³–ï¼Œ
            // é‹å‹•æ™‚æœ‰å¿ƒçµç—›ï¼ŒSTæ®µæ˜é¡¯ä¸‹é™ï¼ŒSTæ–œç‡ä¸‹é™
            'age': 65, 'sex': 1, 'chest pain type': 4, 'resting bp s': 160,
            'cholesterol': 300, 'fasting blood sugar': 1, 'resting ecg': 2,
            'max heart rate': 108, 'exercise angina': 1, 'oldpeak': 3.5, 'ST slope': 3
        },
        low_risk: {
            // å…¸å‹ä½é¢¨éšªï¼š32æ­²å¥³æ€§ï¼Œå…¸å‹å¿ƒçµç—›ï¼Œæ­£å¸¸è¡€å£“ï¼Œæ­£å¸¸è†½å›ºé†‡ï¼Œæ­£å¸¸è¡€ç³–ï¼Œ
            // é‹å‹•æ™‚ç„¡å¿ƒçµç—›ï¼ŒSTæ®µæ­£å¸¸ï¼ŒSTæ–œç‡ä¸Šå‡
            'age': 32, 'sex': 0, 'chest pain type': 1, 'resting bp s': 115,
            'cholesterol': 165, 'fasting blood sugar': 0, 'resting ecg': 0,
            'max heart rate': 185, 'exercise angina': 0, 'oldpeak': 0.0, 'ST slope': 1
        }
    };

    function fillTestData(type) {
        let data;
        if (type === 'random') {
            data = {
                'age': Math.floor(Math.random() * 50) + 30,
                'sex': Math.floor(Math.random() * 2),
                'chest pain type': Math.floor(Math.random() * 4) + 1,
                'resting bp s': Math.floor(Math.random() * 60) + 100,
                'cholesterol': Math.floor(Math.random() * 200) + 150,
                'fasting blood sugar': Math.floor(Math.random() * 2),
                'resting ecg': Math.floor(Math.random() * 3),
                'max heart rate': Math.floor(Math.random() * 80) + 100,
                'exercise angina': Math.floor(Math.random() * 2),
                'oldpeak': (Math.random() * 4).toFixed(1),
                'ST slope': Math.floor(Math.random() * 3) + 1
            };
        } else {
            data = testCases[type];
        }

        for (const [key, value] of Object.entries(data)) {
            const element = document.getElementById(key);
            if (element) {
                element.value = value;
            }
        }
    }

    function generateAdvice(data) {
        let adviceList = [];

        const bp = parseInt(data['resting bp s']);
        if (bp > 140) adviceList.push(`<li><strong>è¡€å£“åé«˜ (${bp} mmHg)</strong>ï¼šå»ºè­°æ¸›å°‘é¹½åˆ†æ”å–ï¼Œé¿å…æ²¹è†©é£Ÿç‰©ã€‚</li>`);
        else if (bp < 90) adviceList.push(`<li><strong>è¡€å£“åä½ (${bp} mmHg)</strong>ï¼šè«‹æ”å–è¶³å¤ æ°´åˆ†ï¼Œæ³¨æ„é ­æšˆã€‚</li>`);

        const chol = parseInt(data['cholesterol']);
        if (chol > 240) adviceList.push(`<li><strong>è†½å›ºé†‡éé«˜ (${chol} mg/dl)</strong>ï¼šå»ºè­°æ¸›å°‘ç´…è‚‰æ”å–ï¼Œå¤šé‹å‹•ã€‚</li>`);
        else if (chol > 200) adviceList.push(`<li><strong>è†½å›ºé†‡åé«˜ (${chol} mg/dl)</strong>ï¼šè«‹æ³¨æ„é£²é£Ÿå‡è¡¡ã€‚</li>`);

        const fbs = parseInt(data['fasting blood sugar']);
        if (fbs == 1) adviceList.push(`<li><strong>ç©ºè…¹è¡€ç³–åé«˜</strong>ï¼šè«‹æ§åˆ¶ç³–åˆ†æ”å–ï¼Œé€™æ˜¯ç³–å°¿ç—…é¢¨éšªå› å­ã€‚</li>`);

        const maxHR = parseInt(data['max heart rate']);
        if (maxHR < 100) adviceList.push(`<li><strong>æœ€å¤§å¿ƒç‡åä½ (${maxHR})</strong>ï¼šå»ºè­°è«®è©¢é†«å¸«è©•ä¼°å¿ƒè‡ŸåŠŸèƒ½ã€‚</li>`);

        if (adviceList.length === 0) {
            return `<div class="alert alert-success mt-3 text-start">
                        <h5><i class="fas fa-check-circle me-2"></i>å¥åº·ç‹€æ³è‰¯å¥½</h5>
                        <p class="mb-0">æ‚¨çš„ä¸»è¦ç”Ÿç†æŒ‡æ¨™éƒ½åœ¨æ­£å¸¸ç¯„åœå…§ã€‚</p>
                    </div>`;
        }

        return `<div class="alert alert-info mt-3 text-start">
                    <h5><i class="fas fa-user-md me-2"></i>é†«å¸«å°å®åš€ï¼š</h5>
                    <ul class="mb-0 ps-3">
                        ${adviceList.join('')}
                    </ul>
                </div>`;
    }

    // --- æ–°å¢ï¼šç•«é›·é”åœ–çš„å‡½æ•¸ (æˆ‘æŠŠé€™æ®µç§»é€²ä¾†äº†) ---
    let myRadarChart = null;

    function drawRadarChart(data) {
        // ç¢ºä¿ç•«å¸ƒå­˜åœ¨æ‰åŸ·è¡Œ
        const canvas = document.getElementById('radarChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const container = document.getElementById('chartContainer');
        container.style.display = 'block';

        // å¦‚æœåœ–è¡¨å·²ç¶“å­˜åœ¨ï¼Œå…ˆéŠ·æ¯€å®ƒ (ä¸ç„¶æ»‘é¼ ç§»ä¸Šå»æœƒé–ƒçˆ)
        if (myRadarChart) {
            myRadarChart.destroy();
        }

        // æº–å‚™æ•¸æ“š (é€™è£¡åšäº†ä¸€äº›ç°¡å–®çš„æ¨™æº–åŒ–ï¼Œè®“åœ–å¥½çœ‹ä¸€é»)
        const userBP = parseInt(data['resting bp s']);
        const userChol = parseInt(data['cholesterol']);
        const userHR = parseInt(data['max heart rate']);

        // é¿å…åœ–è¡¨ç ´è¡¨ï¼Œè¨­å®šä¸Šé™
        const normalize = (val, standard) => Math.min((val / standard) * 100, 150);

        myRadarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['éœæ¯è¡€å£“', 'è†½å›ºé†‡', 'æœ€å¤§å¿ƒç‡', 'å¹´é½¡é¢¨éšª', 'ç©ºè…¹è¡€ç³–'],
                datasets: [{
                    label: 'æ‚¨çš„æ•¸å€¼',
                    data: [
                        normalize(userBP, 120),
                        normalize(userChol, 200),
                        normalize(userHR, 150),
                        normalize(parseInt(data['age']), 60),
                        parseInt(data['fasting blood sugar']) === 1 ? 130 : 80
                    ],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2
                }, {
                    label: 'æ¨™æº–åƒè€ƒç·š',
                    data: [100, 100, 100, 100, 100],
                    borderColor: 'rgba(200, 200, 200, 0.8)',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { display: false },
                        suggestedMin: 0,
                        suggestedMax: 140,
                        ticks: { display: false }
                    }
                }
            }
        });
    }

    document.getElementById('predictForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const spinner = document.querySelector('.loading-spinner');
        const resultPanel = document.getElementById('resultPanel');

        spinner.style.display = 'inline-block';

        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });

        try {
            const response = await fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.error) {
                resultPanel.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>é æ¸¬å¤±æ•—ï¼š${result.error}
                </div>
            `;
            } else {
                const isPositive = result.prediction === 1;
                const bgClass = isPositive ? 'positive' : 'negative';
                const icon = isPositive ? 'fa-exclamation-triangle' : 'fa-check-circle';

                const adviceHtml = generateAdvice(data);

                resultPanel.innerHTML = `
                <div class="result-card ${bgClass} text-center">
                    <i class="fas ${icon} fa-4x mb-3"></i>
                    <h3 class="mb-3">${result.result_text}</h3>
                    <div class="mb-3">
                        <span class="display-4">${result.probability}%</span>
                        <p class="mb-0">é¢¨éšªæ©Ÿç‡</p>
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.3)">
                    <p class="mb-0 small">
                        <i class="fas fa-robot me-1"></i>
                        ä½¿ç”¨æ¨¡å‹: ${getModelName(result.model_used)}
                    </p>
                </div>
                ${adviceHtml}

                <!-- é›·é”åœ–å€å¡Š - ä¿®æ­£ï¼šç§»é™¤é€™è£¡çš„å¼·åˆ¶ 300px é«˜åº¦ï¼Œæ”¹æˆåŒ…åœ¨ canvas å¤–é¢ -->
                <div class="mt-4" id="chartContainer" style="display: none;">
                    <h5 class="text-start"><i class="fas fa-chart-pie me-2"></i>æ•¸å€¼åˆ†æé›·é”åœ–</h5>
                    <!-- æ–°å¢ä¸€å€‹ wrapper ä¾†æ§åˆ¶é«˜åº¦ï¼Œé€™æ¨£æ‰ä¸æœƒè·Ÿæ–‡å­—æ‰“æ¶ -->
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <p class="text-muted small mt-2">è—è‰²å€åŸŸï¼šæ‚¨çš„æ•¸å€¼ | ç°è‰²è™›ç·šï¼šä¸€èˆ¬æ¨™æº–åƒè€ƒå€¼</p>
                </div>

                <!-- ä¸‹è¼‰æŒ‰éˆ• -->
                <div class="d-grid gap-2 mt-3">
                    <button onclick="window.print()" class="btn btn-secondary">
                        <i class="fas fa-file-pdf me-2"></i>ä¸‹è¼‰/åˆ—å°æª¢æ¸¬å ±å‘Š
                    </button>
                </div>
            `;

                // ğŸ”¥ é—œéµä¿®æ­£ï¼šåœ¨é€™è£¡å‘¼å«ç•«åœ–å‡½æ•¸ï¼ˆå› ç‚ºä¸Šé¢çš„ innerHTML åŸ·è¡Œå®Œï¼Œç•«å¸ƒæ‰å­˜åœ¨ï¼‰
                setTimeout(() => drawRadarChart(data), 100);
            }
        } catch (error) {
            resultPanel.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>é æ¸¬å¤±æ•—ï¼š${error.message}
            </div>
        `;
        }
        spinner.style.display = 'none';
    });

    function getModelName(modelKey) {
        const names = {
            'logistic_regression': 'Logistic Regression',
            'random_forest': 'Random Forest',
            'tf_model_sgd': 'TensorFlow (SGD)',
            'tf_model_adam': 'TensorFlow (Adam)',
            'tf_model_final': 'TensorFlow (Final)'
        };
        return names[modelKey] || modelKey;
    }
</script>
{% endblock %}